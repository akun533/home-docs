<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•è¯„è®ºã€ç‚¹èµã€è®¿é—®é‡åŠŸèƒ½</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #3eaf7c;
            border-radius: 8px;
        }
        h2 {
            color: #3eaf7c;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #3eaf7c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #2d8659;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª åšå®¢åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>
    
    <!-- è®¿é—®é‡æµ‹è¯• -->
    <div class="test-section">
        <h2>ğŸ“Š è®¿é—®é‡ç»Ÿè®¡æµ‹è¯•</h2>
        <button onclick="testPageView()">è®°å½•è®¿é—®</button>
        <button onclick="getPageViews()">è·å–è®¿é—®é‡</button>
        <div id="viewResult" class="result"></div>
    </div>

    <!-- ç‚¹èµæµ‹è¯• -->
    <div class="test-section">
        <h2>â¤ï¸ ç‚¹èµåŠŸèƒ½æµ‹è¯•</h2>
        <button onclick="toggleLike()">ç‚¹èµ/å–æ¶ˆ</button>
        <button onclick="checkLike()">æ£€æŸ¥çŠ¶æ€</button>
        <div id="likeResult" class="result"></div>
    </div>

    <!-- è¯„è®ºæµ‹è¯• -->
    <div class="test-section">
        <h2>ğŸ’¬ è¯„è®ºåŠŸèƒ½æµ‹è¯•</h2>
        <button onclick="postComment()">å‘è¡¨è¯„è®º</button>
        <button onclick="getComments()">è·å–è¯„è®ºåˆ—è¡¨</button>
        <div id="commentResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:43000/api';
        const TEST_PAGE = '/test-page';

        function getUserId() {
            let userId = localStorage.getItem('userId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
            }
            return userId;
        }

        function getVisitorId() {
            let visitorId = localStorage.getItem('visitorId');
            if (!visitorId) {
                visitorId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('visitorId', visitorId);
            }
            return visitorId;
        }

        async function testPageView() {
            const result = document.getElementById('viewResult');
            try {
                const response = await fetch(`${API_BASE}/analytics/view`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pageUrl: TEST_PAGE,
                        visitorId: getVisitorId()
                    })
                });
                const data = await response.json();
                result.className = 'result success';
                const countedMsg = data.data.counted ? 'âœ… è®¡æ•°æˆåŠŸ' : 'âš ï¸ 10åˆ†é’Ÿå†…å·²è®¿é—®ï¼Œæœªè®¡æ•°';
                result.textContent = `${countedMsg}\n\n` + JSON.stringify(data, null, 2);
            } catch (error) {
                result.className = 'result error';
                result.textContent = 'âŒ é”™è¯¯: ' + error.message;
            }
        }

        async function getPageViews() {
            const result = document.getElementById('viewResult');
            try {
                const response = await fetch(`${API_BASE}/analytics/page?pageUrl=${encodeURIComponent(TEST_PAGE)}`);
                const data = await response.json();
                result.className = 'result success';
                result.textContent = 'âœ… è®¿é—®é‡æ•°æ®ï¼š\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                result.className = 'result error';
                result.textContent = 'âŒ é”™è¯¯: ' + error.message;
            }
        }

        async function toggleLike() {
            const result = document.getElementById('likeResult');
            try {
                const response = await fetch(`${API_BASE}/likes/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pageUrl: TEST_PAGE,
                        userId: getUserId()
                    })
                });
                const data = await response.json();
                result.className = 'result success';
                result.textContent = 'âœ… ç‚¹èµæ“ä½œæˆåŠŸï¼\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                result.className = 'result error';
                result.textContent = 'âŒ é”™è¯¯: ' + error.message;
            }
        }

        async function checkLike() {
            const result = document.getElementById('likeResult');
            try {
                const response = await fetch(
                    `${API_BASE}/likes/check?pageUrl=${encodeURIComponent(TEST_PAGE)}&userId=${getUserId()}`
                );
                const data = await response.json();
                result.className = 'result success';
                result.textContent = 'âœ… ç‚¹èµçŠ¶æ€ï¼š\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                result.className = 'result error';
                result.textContent = 'âŒ é”™è¯¯: ' + error.message;
            }
        }

        async function postComment() {
            const result = document.getElementById('commentResult');
            try {
                const response = await fetch(`${API_BASE}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pageUrl: TEST_PAGE,
                        content: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯„è®º ' + new Date().toLocaleTimeString(),
                        author: 'æµ‹è¯•ç”¨æˆ·',
                        email: 'test@example.com'
                    })
                });
                const data = await response.json();
                result.className = 'result success';
                result.textContent = 'âœ… è¯„è®ºå‘è¡¨æˆåŠŸï¼\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                result.className = 'result error';
                result.textContent = 'âŒ é”™è¯¯: ' + error.message;
            }
        }

        async function getComments() {
            const result = document.getElementById('commentResult');
            try {
                const response = await fetch(`${API_BASE}/comments?pageUrl=${encodeURIComponent(TEST_PAGE)}`);
                const data = await response.json();
                result.className = 'result success';
                result.textContent = 'âœ… è¯„è®ºåˆ—è¡¨ï¼š\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                result.className = 'result error';
                result.textContent = 'âŒ é”™è¯¯: ' + error.message;
            }
        }
    </script>
</body>
</html>
